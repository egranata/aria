# SPDX-License-Identifier: Apache-2.0
import guard from aria.utils.guard;

struct GuardOne {
    type val COUNTER = 1;

    func guard_exit() {
        GuardOne.COUNTER = GuardOne.COUNTER + GuardTwo.COUNTER;
    }
}

struct GuardTwo {
    type val COUNTER = 2;

    func guard_exit() {
        GuardTwo.COUNTER = GuardTwo.COUNTER + GuardOne.COUNTER;
    }
}

func add(x,y) {
    return guard(alloc(GuardOne)).do(|_| => {
        return guard(alloc(GuardTwo)).do(|_| => {
            return x + y;
        });
    });
}

func add_again(x,y) {
    return guard(alloc(GuardTwo)).do(|_| => {
        return guard(alloc(GuardOne)).do(|_| => {
            return x + y;
        });
    });
}

func main() {
    val n = add(3,4);
    assert n == 7;
    assert GuardTwo.COUNTER == 3;
    assert GuardOne.COUNTER == 4;

    GuardOne.COUNTER = 1;
    GuardTwo.COUNTER = 2;

    n = add_again(3,4);
    assert n == 7;
    assert GuardOne.COUNTER == 3;
    assert GuardTwo.COUNTER == 5;
}
