# SPDX-License-Identifier: Apache-2.0

### TAGS: FLAKEY

import Request from aria.network.request;
import * from aria.network.retry;

func main() {
    val request = Request.new("https://www.rust-lang.org/");
    val response = retry(|| => request.get(), |result| => {
        println(result);
        match result {
            case Ok(response) => {
                val code = response.status_code;
                return code == 200 || code == 503;
            }
        } else {
            return false;
        }
    });

    response = response.unwrap_Pass()!!;
    if response.status_code == 503 {
        println("Service Unavailable, try again later");
        return true;
    }

    assert response.headers["content-type"].contains("html");
    assert response.content.contains("<html");
}
